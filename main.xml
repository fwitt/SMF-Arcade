<?xml version="1.0"?>
<?xml-stylesheet href="modification.xsl" type="text/xsl"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

	ATTENTION: If you are trying to install this manually, you should try
	the package manager.  If it will not work for you, please take a look
	at the following for information on this format:
		http://mods.simplemachines.org/docs/manual-install.php

================================================================================

	Modification files can be used to modify files so that they do what
	your package needs them to do to work properly.

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<!-- This information needs to be the same as that in the package-info.xml. -->
	<id>Niko:Arcade</id>
	<version>2.5 RC1.1C</version>

	<file name="$boarddir/index.php">
		<operation>
			<search position="after"><![CDATA[	// Is the forum in maintenance mode? (doesn't apply to administrators.)]]></search>
			<add><![CDATA[	$check_score = smfArcade_submit();	
	if ($check_score) {return $check_score;}
	
]]></add>
		</operation>		
	</file>
	<file name="$sourcedir/Admin.php">
		<operation>
			<search position="replace"><![CDATA[loadLanguage(implode('+', $language_files));]]></search>
			<add><![CDATA[$language_files[] = 'ArcadeAdmin';
			
	loadLanguage(implode('+', $language_files));]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[foreach ($include_files as $file)
		require_once($sourcedir . '/' . $file . '.php');]]></search>
			<add><![CDATA[$include_files[] = 'ArcadeAdmin';
	$include_files[] = 'Subs-Arcade';
	
	foreach ($include_files as $file)
		require_once($sourcedir . '/' . $file . '.php');]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[foreach ($settings_search as $setting_area)]]></search>
			<add><![CDATA[$settings_search[] = array('ArcadeAdminSettings', 'area=arcade;sa=settings');
	$settings_search[] = array('ArcadeAdminPemission', 'area=arcade;sa=permission');
		
	foreach ($settings_search as $setting_area)]]></add>
		</operation>									
	</file>
	<file name="$sourcedir/Subs-Db-mysql.php">
		<operation>
			<search position="after"><![CDATA[
	if (!isset($matches[2]))]]></search>
			<add><![CDATA[
	global $user_info;
	$queryArena = array('query_see_game', 'query_see_match', 'query_arena_game');
	foreach ($queryArena as $arena)
	{
		if ($matches[1] === $arena)
			return $user_info[$arena];
	}	
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Db-sqlite.php">
		<operation>
			<search position="after"><![CDATA[
	if (!isset($matches[2]))]]></search>
			<add><![CDATA[
	global $user_info;
	$queryArena = array('query_see_game', 'query_see_match', 'query_arena_game');
	foreach ($queryArena as $arena)
	{
		if ($matches[1] === $arena)
			return $user_info[$arena];
	}	
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Db-postgresql.php">
		<operation>
			<search position="after"><![CDATA[
	if (!isset($matches[2]))]]></search>
			<add><![CDATA[
	global $user_info;
	$queryArena = array('query_see_game', 'query_see_match', 'query_arena_game');
	foreach ($queryArena as $arena)
	{
		if ($matches[1] === $arena)
			return $user_info[$arena];
	}	
]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Who.php">
		<operation>
			<search position="after"><![CDATA[		// Probably an error or some goon?]]></search>
			<add><![CDATA[		elseif ($actions['action'] == 'arcade')
		{

			if (!isset($actions['sa']) || $actions['sa'] == 'list')
				// Viewing index
				$data[$k] = $txt['who_arcade'];
			elseif ($actions['sa'] == 'play' && isset($actions['game']))
				// Playing game
				$game_ids[(int) $actions['game']][$k] = $txt['who_arcade_play'];
			elseif ($actions['sa'] == 'highscore' && isset($actions['game']))
				// Viewing highscores of game
				$game_ids[(int) $actions['game']][$k] = $txt['who_arcade_highscore'];
			else
				// Something else, let's say it's index
				$data[$k] = $txt['who_arcade'];

		}
]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[	// Load member names for the profile.]]></search>
			<add><![CDATA[	if (!empty($game_ids) && allowedTo('view_arcade'))
	{
		$result = $smcFunc['db_query']('', '
			SELECT id_game, game_name
			FROM {db_prefix}arcade_games
			WHERE id_game IN ({array_int:games})
			LIMIT {int:limit}',
			array(
				'games' => array_keys($game_ids),
				'limit' => count($game_ids)
			));

		while ($row = $smcFunc['db_fetch_assoc']($result))
			foreach ($game_ids[$row['id_game']] as $k => $session_text)
				$data[$k] = sprintf($session_text, $row['id_game'], $row['game_name']);
	  $smcFunc['db_free_result']($result);
	}
]]></add>
		</operation>
	</file>


	<file name="$sourcedir/Modlog.php">
		<operation>
			<search position="after"><![CDATA[	$messages = array();]]></search>
			<add><![CDATA[	$games = array();
]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[		// A message?]]></search>
			<add><![CDATA[
		// A game?
		if (isset($row['extra']['game']))
			$games[(int) $row['extra']['game']][] = $row['id_action'];
]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA[	if (!empty($messages))]]></search>
			<add><![CDATA[	if (!empty($games))
	{
		$result = $smcFunc['db_query']('', '
			SELECT id_game, game_name
			FROM {db_prefix}arcade_games
			WHERE id_game IN ({array_int:games})
			LIMIT ' . count(array_keys($games)),
			array(
				'games' => array_keys($games),
			)
		);

		while ($row = $smcFunc['db_fetch_assoc']($result))
		{
			foreach ($games[$row['id_game']] as $action)
			{
				$this_action = &$entries[$action];
				$this_action['extra']['game'] = '<a href="' . $scripturl . '?action=arcade;game=' . $row['id_game'] . '">' . $row['game_name'] . '</a>';
			}
		}
	  $smcFunc['db_free_result']($result);
	}
]]></add>
		</operation>

		<operation>
			<search position="after"><![CDATA['new_topic') as $type)]]></search>
			<add><![CDATA['game', ]]></add>
		</operation>
	</file>

</modification>